+++
author = "pureone"
title = "入門監視"
date = "2020-06-29"
description = "monitoring tips"
categories = [
  "SRE",
]
tags = [
    "SRE",
    "monitoring",
]
+++

> *監視とは、あるシステムやそのシステムのコンポーネントの振る舞いや出力を観察しチェックし続ける行為である。*


## アンチパターン
- ツール依存（銀の弾丸はない。
- 監視を役割にする (本来監視とはスキルである。)
- チェックボックス監視 (監視しているというチェック)
  - メトリクス(CPU使用率、メモリ使用率、システム負荷)を監視しているが、ダウンした理由が不明
  - 5分以上の間隔でメトリクスを収集
  - メトリクスの履歴を保存していない
- 動いているの定義が曖昧 (自プロダクトの動いている状態とは？どんな状態ですか？)
- 動いているかを基準にしないメトリクスのアラート
- 手動設定
  - 監視自体ではなく、監視設定の追加/変更に時間がかかっている。100%自動化すべき

## デザインパターン
> 組み合わせ可能な監視の仕組みは、ものりシックな仕組みよりも効果的だよ。
- コンポーネント(compasable monitoring)、データ収集(Push, Pull)、メトリクス(Counter, Gauge)
> ユーザ視点優先の監視によって、効果的な可視化ができるよ。
- HTTPレスポンスエラーコード > インスタンス数
> 監視の仕組みは、可能な限り自分で作るのではなく購入しよう。
- SaaS
> 常に改善し続けよう。  
- 世界レベルの仕組みは改善してできている。明日にはそうでないかもしれないから。

## アラート、オンコール、インシデント管理
> アラート
- アラートをメールで送らないようにしよう。(SMS,PagerDutyなどでページャーへ送るようにしよう)
- 手順書を書こう。
- 全てのアラートがシンプルな閾値で決められるわけではない(使用率ではなく、使用率の増加量を閾値にする)
- メンテナンス期間を使おう。(アラートの停止期間)
- 自動復旧を試そう。
- ポストモーテム(検死)をしよう。結果は何かに残して共有しよう。

## 統計
- 平均、中央値(データセット)を使おう。
- 周期性は、時系列データのパターンの表現方法として使おう。
- パーセンタイルでデータの大部分を把握しよう。

## ビジネス監視
- ビジネスKPIと技術指標の紐付け
- ビジネスKPIの見つけ方
  - アプリケーションが動いているかどうやって知ったら良いか？
  - それは何をチェックしているか？
  - どう動いたら良いのか？

## フロントエンド
- 素早くロードされることが重要である。
- リアルユーザ監視とシンセティック監視(監視に使うトラフィックの種類の違い)がある。
- Navigation Timing API を活用しよう。
- GAにメトリクスデータを送信しよう。

## アプリケーション監視
- メトリクスとログでアプリケーションを計測することは、パフォーマンスを把握し、トラブルシューティングする能力を高めるために重要なことである。
- /healthエンドポイントパターンは、なかなか良い。
- マイクロサービスの監視は分散トレーシングをやろう。

## サーバ監視
- Linuxのメモリ管理では、ディスクの中で最近アクセスされた領域のファイルシステムメタデータはbuffers。ファイルのコンテンツはcachedに保存される。
- OOMKillerのログも確認しておこう。
- ネットワークはイン/アウトのオクテット数、エラー数、ドロップ数を収集しよう。
- ディスクI/O
- ロードアベレージ
- Webサーバでは秒間リクエスト数 (req/sec)。スループットの指標。keepalivesの考慮は必要。
- データベースはIOPSを考慮しよう。
- キャッシュは、追い出されたアイテム数(evicted items)と、ヒット/ミス比率(hit/miss ratio, cache-hit ratio（- メッセージキューは、キューの長さ(queue length)と、消費率(consumption rate（
- メッセージキューは、キューの長さ(ueue length)と、消費率(consumption rate)を監視する。

## ネットワーク監視
- SNMP(Simple Network Management Protocol)は、ポート161,162を使うUDPベースのプロトコル。ポーリングを161で行い、トラップ(デバイスからのアウトバウンド)は162が使われる。
- 帯域幅(bandwidth)、スループット(throughput)、レイテンシ(latency)、エラー(errors)、ジッタ(jitter)

# FYI 
- コードレベルの監視（APM(Application Performance Management) Toos, プロファイリングツール
- Prometheus
- roll-up（データの間引き設定）
- 1つのことを行い、またそれをうまくやるプログラムを書け。協調して動くプログラムを書け。-Doug Mcllroy- ロギングデーモン
- 移動平均 (moving average)、信頼区間 (confidence band)、標準偏差 (standard deviation)
- オンコールとは問題が起きたときの担当者のこと
- FTS Follow the Sun

